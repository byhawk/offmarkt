<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Baron Admin - Oyuncular</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar will be loaded by sidebar.js -->

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1>Oyuncular</h1>
                <div class="header-actions">
                    <input type="text" id="searchInput" placeholder="Oyuncu ara..." class="search-input">
                    <button onclick="refreshPlayers()" class="btn-refresh">ðŸ”„ Yenile</button>
                </div>
            </header>

            <!-- Filters -->
            <div class="filters">
                <select id="statusFilter" onchange="filterPlayers()">
                    <option value="">TÃ¼m Durumlar</option>
                    <option value="active">Aktif</option>
                    <option value="banned">BanlÄ±</option>
                </select>
                <select id="sortBy" onchange="filterPlayers()">
                    <option value="createdAt">KayÄ±t Tarihi</option>
                    <option value="level">Seviye</option>
                    <option value="cash">Para</option>
                    <option value="totalProfit">Toplam Kar</option>
                    <option value="shopsOwned">DÃ¼kkan SayÄ±sÄ±</option>
                    <option value="earlierActive">Son Aktivite</option>
                </select>
                <select id="economicFilter" onchange="filterPlayers()">
                    <option value="">TÃ¼m Ekonomik Durum</option>
                    <option value="shop_owner">DÃ¼kkan Sahibi</option>
                    <option value="no_shop">DÃ¼kkansÄ±z</option>
                    <option value="high_profit">YÃ¼ksek Kar (>5M)</option>
                    <option value="completing_objectives">Aktif</option>
                </select>
            </div>

            <!-- Players Table -->
            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>KullanÄ±cÄ± AdÄ±</th>
                                <th>Email</th>
                                <th>Seviye</th>
                                <th>Para</th>
                                <th>Toplam Kar</th>
                                <th>Durum</th>
                                <th>KayÄ±t Tarihi</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="playersTable">
                            <tr><td colspan="8" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Ban Modal -->
    <div id="banModal" class="modal">
        <div class="modal-content">
            <h2>Oyuncuyu Banla</h2>
            <form id="banForm">
                <div class="form-group">
                    <label>Sebep</label>
                    <textarea id="banReason" required></textarea>
                </div>
                <div class="form-group">
                    <label>SÃ¼re (gÃ¼n)</label>
                    <input type="number" id="banDuration" min="1" value="7">
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeBanModal()" class="btn-secondary">Ä°ptal</button>
                    <button type="submit" class="btn-danger">Banla</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allPlayers = [];
        let selectedPlayerId = null;

        async function loadPlayers() {
            const result = await getPlayers();
            if (result && result.success) {
                allPlayers = result.data.players || result.data || [];
                displayPlayers(allPlayers);
            }
        }

        function displayPlayers(players) {
            const tbody = document.getElementById('playersTable');
            if (!players || players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Oyuncu bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = players.map(player => `
                <tr>
                    <td><strong>${player.username}</strong></td>
                    <td>${player.email}</td>
                    <td>Lvl ${player.level}</td>
                    <td>${formatCurrency(player.cash)}</td>
                    <td>${formatCurrency(player.totalProfit)}</td>
                    <td>
                        <span class="badge ${player.isBanned ? 'badge-danger' : 'badge-success'}">
                            ${player.isBanned ? 'BanlÄ±' : 'Aktif'}
                        </span>
                    </td>
                    <td>${formatDate(player.createdAt)}</td>
                    <td>
                        <button onclick="viewPlayer('${player._id}')" class="btn-sm">Detay</button>
                        ${player.isBanned 
                            ? `<button onclick="unbanPlayerAction('${player._id}')" class="btn-sm btn-success">Unban</button>`
                            : `<button onclick="openBanModal('${player._id}')" class="btn-sm btn-danger">Ban</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        function filterPlayers() {
            const status = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            const economic = document.getElementById('economicFilter').value;

            let filtered = [...allPlayers];

            // Status filtresini uygula
            if (status === 'active') {
                filtered = filtered.filter(p => !p.isBanned);
            } else if (status === 'banned') {
                filtered = filtered.filter(p => p.isBanned);
            }

            // Ekonomik filtresini uygula
            if (economic) {
                switch (economic) {
                    case 'shop_owner':
                        filtered = filtered.filter(p => p.ownedShops && p.ownedShops.length > 0);
                        break;
                    case 'no_shop':
                        filtered = filtered.filter(p => !p.ownedShops || p.ownedShops.length === 0);
                        break;
                    case 'high_profit':
                        filtered = filtered.filter(p => p.totalProfit > 5000000); // 5M TL Ã¼stÃ¼
                        break;
                    case 'completing_objectives':
                        filtered = filtered.filter(p => p.isOnline && p.lastActivity);
                        break;
                }
            }

            // SÄ±ralama uygula
            filtered.sort((a, b) => {
                if (sortBy === 'createdAt') return new Date(b.createdAt) - new Date(a.createdAt);
                if (sortBy === 'level') return b.level - a.level;
                if (sortBy === 'cash') return b.cash - a.cash;
                if (sortBy === 'totalProfit') return b.totalProfit - a.totalProfit;
                if (sortBy === 'shopsOwned') return (b.ownedShops?.length || 0) - (a.ownedShops?.length || 0);
                if (sortBy === 'earlierActive') return new Date(a.lastActivity || a.createdAt) - new Date(b.lastActivity || b.createdAt);
                return 0;
            });

            displayPlayers(filtered);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = allPlayers.filter(p => 
                p.username.toLowerCase().includes(search) ||
                p.email.toLowerCase().includes(search)
            );
            displayPlayers(filtered);
        });

        function openBanModal(playerId) {
            selectedPlayerId = playerId;
            document.getElementById('banModal').style.display = 'flex';
        }

        function closeBanModal() {
            document.getElementById('banModal').style.display = 'none';
            selectedPlayerId = null;
        }

        document.getElementById('banForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = document.getElementById('banReason').value;
            const duration = parseInt(document.getElementById('banDuration').value);
            
            const result = await banPlayer(selectedPlayerId, reason, duration);
            if (result && result.success) {
                alert('Oyuncu baÅŸarÄ±yla banlandÄ±');
                closeBanModal();
                loadPlayers();
            }
        });

        async function unbanPlayerAction(playerId) {
            if (!confirm('Bu oyuncunun banÄ±nÄ± kaldÄ±rmak istediÄŸinizden emin misiniz?')) return;
            
            const result = await unbanPlayer(playerId);
            if (result && result.success) {
                alert('Ban baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±');
                loadPlayers();
            }
        }

        function viewPlayer(playerId) {
            window.location.href = `/player-detail.html?id=${playerId}`;
        }

        function refreshPlayers() {
            loadPlayers();
        }

        // Load on page load
        loadPlayers();
    </script>
</body>
</html>
