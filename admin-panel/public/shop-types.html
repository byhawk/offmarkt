<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffMarket Admin - D√ºkkan √áe≈üitleri</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar will be loaded by sidebar.js -->

        <main class="main-content">
            <!-- Shop Types Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üõçÔ∏è</div>
                    <div class="stat-content">
                        <h3 id="total-shop-types">0</h3>
                        <p>D√ºkkan √áe≈üidi</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <h3 id="total-revenue">‚Ç∫0</h3>
                        <p>Toplam Satƒ±≈ü</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè™</div>
                    <div class="stat-content">
                        <h3 id="active-instances">0</h3>
                        <p>Aktif Maƒüaza</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3 id="popular-type">-</h3>
                        <p>Pop√ºler T√ºr</p>
                    </div>
                </div>
            </div>

            <header class="header">
                <h1>D√ºkkan √áe≈üitleri Y√∂netimi</h1>
                <div class="header-actions">
                    <button onclick="openCreateModal()" class="btn-refresh">‚ûï D√ºkkan √áe≈üidi Ekle</button>
                    <button onclick="refreshShopTypes()" class="btn-refresh">üîÑ Yenile</button>
                </div>
            </header>

            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√áe≈üit</th>
                                <th>G√∂r√ºn√ºm Adƒ±</th>
                                <th>Satƒ±n Alma √úcreti</th>
                                <th>Raf Kapasitesi</th>
                                <th>Depo Kapasitesi</th>
                                <th>A√ßƒ±lan Maƒüaza</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="shopTypesTable">
                            <tr><td colspan="8" class="loading">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Create/Edit Modal -->
    <div id="shopTypeModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">D√ºkkan √áe≈üidi Ekle</h2>
            <form id="shopTypeForm">
                <div class="form-group">
                    <label>√áe≈üit Kodu</label>
                    <select id="shopTypeCode" required>
                        <option value="supermarket">supermarket</option>
                        <option value="flower_shop">flower_shop</option>
                        <option value="clothing_store">clothing_store</option>
                        <option value="jewelry_store">jewelry_store</option>
                        <option value="food_shop">food_shop</option>
                        <option value="electronics">electronics</option>
                        <option value="general">general</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>G√∂r√ºn√ºm Adƒ±</label>
                    <input type="text" id="displayName" placeholder="√∂rn: S√ºpermarket" required>
                </div>
                <div class="form-group">
                    <label>ƒ∞sim ≈ûablonu</label>
                    <input type="text" id="nameTemplate" placeholder="√∂rn: {≈ûEHƒ∞R} S√ºpermarket" value="{≈ûEHƒ∞R} {T√úR}" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Raf Kapasitesi</label>
                        <input type="number" id="rackCapacity" placeholder="√∂rn: 2000" min="100" required>
                    </div>
                    <div class="form-group">
                        <label>Depo Kapasitesi (adet)</label>
                        <input type="number" id="storageCapacity" placeholder="√∂rn: 5000" min="100" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Satƒ±n Alma √úcreti (‚Ç∫)</label>
                        <input type="number" id="purchasePrice" placeholder="√∂rn: 25000" min="1000" required>
                    </div>
                    <div class="form-group">
                        <label>Minimum M√º≈üteri</label>
                        <input type="number" id="minCustomers" placeholder="√∂rn: 100" min="0" value="10" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lokasyon T√ºr√º</label>
                        <select id="locationType" required>
                            <option value="street">Sokak</option>
                            <option value="mall">AVM</option>
                            <option value="market">Pazar</option>
                            <option value="office">Ofis</option>
                            <option value="warehouse">Depo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="isActive" required>
                            <option value="true" selected>Aktif</option>
                            <option value="false">Pasif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeModal()" class="btn-secondary">ƒ∞ptal</button>
                    <button type="submit" class="btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allShopTypes = [];
        let editingTypeId = null;

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadShopTypes();
        });

        async function loadShopTypes() {
            try {
                const result = await API.call('/shop-types');
                console.log('Shop types result:', result);
                if (result && result.success) {
                    allShopTypes = result.data.shopTypes || [];
                    const summary = result.data.summary || {};
                    updateStats(summary);
                    displayShopTypes(allShopTypes);
                } else {
                    const errorMsg = result ? (result.message || 'Bilinmeyen hata') : 'API isteƒüi ba≈üarƒ±sƒ±z (null response)';
                    console.error('Shop types error:', errorMsg);
                    showNotification('Endpoint Hatasƒ±: ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('Shop types load exception:', error);
                showNotification('JavaScript Hatasƒ±: ' + error.message, 'error');
            }
        }

        function updateStats(summary) {
            document.getElementById('total-shop-types').textContent = summary.totalTypes || 0;
            document.getElementById('total-revenue').textContent = '‚Ç∫' + formatCurrency(summary.totalRevenue || 0);
            document.getElementById('active-instances').textContent = summary.totalInstances || 0;
            document.getElementById('popular-type').textContent = summary.mostPopularType || '-';
        }

        function displayShopTypes(types) {
            const tbody = document.getElementById('shopTypesTable');
            if (!types || types.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">D√ºkkan √ße≈üidi bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = types.map(type => {
                const isActive = type.isActive;
                const emoji = getShopTypeEmoji(type.shopType);

                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${emoji} ${type.displayName}</strong>
                                <br>
                                <small class="text-muted">${type.shopType}</small>
                            </div>
                        </td>
                        <td>${type.displayName}</td>
                        <td>‚Ç∫${formatCurrency(type.purchasePrice)}</td>
                        <td>${type.rackCapacity.toLocaleString()}</td>
                        <td>${type.storageCapacity.toLocaleString()}</td>
                        <td>${type.instanceCount || 0}</td>
                        <td>
                            <span class="badge ${isActive ? 'success' : 'secondary'}">
                                ${isActive ? 'Aktif' : 'Pasif'}
                            </span>
                        </td>
                        <td>
                            <button onclick="editShopType('${type._id}')" class="btn-sm">‚úèÔ∏è D√ºzenle</button>
                            ${isActive ?
                                `<button onclick="deactivateShopType('${type._id}')" class="btn-sm danger">üö´ Devre Dƒ±≈üƒ±</button>` :
                                `<button onclick="activateShopType('${type._id}')" class="btn-sm success">‚úÖ Aktifle≈ütir</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getShopTypeEmoji(type) {
            const emojis = {
                supermarket: 'üè™',
                flower_shop: 'üå∏',
                clothing_store: 'üëï',
                jewelry_store: 'üíé',
                food_shop: 'üçî',
                electronics: 'üì±',
                general: 'üè†'
            };
            return emojis[type] || 'üè™';
        }

        function openCreateModal() {
            editingTypeId = null;
            document.getElementById('modalTitle').textContent = 'D√ºkkan √áe≈üidi Ekle';
            document.getElementById('shopTypeForm').reset();
            document.getElementById('shopTypeModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('shopTypeModal').style.display = 'none';
            editingTypeId = null;
        }

        async function editShopType(id) {
            const type = allShopTypes.find(t => t._id === id);
            if (!type) return;

            editingTypeId = id;
            document.getElementById('modalTitle').textContent = 'D√ºkkan √áe≈üidi D√ºzenle';

            // Form'u doldur
            document.getElementById('shopTypeCode').value = type.shopType;
            document.getElementById('displayName').value = type.displayName;
            document.getElementById('nameTemplate').value = type.nameTemplate;
            document.getElementById('purchasePrice').value = type.purchasePrice;
            document.getElementById('rackCapacity').value = type.rackCapacity;
            document.getElementById('storageCapacity').value = type.storageCapacity;
            document.getElementById('minCustomers').value = type.minCustomers;
            document.getElementById('locationType').value = type.locationType;
            document.getElementById('isActive').value = type.isActive.toString();

            document.getElementById('shopTypeModal').style.display = 'flex';
        }

        async function deactivateShopType(id) {
            if (!confirm('Bu d√ºkkan √ße≈üidini devre dƒ±≈üƒ± bƒ±rakmak istediƒüinize emin misiniz?')) return;

            try {
                const result = await API.call(`/shop-types/${id}/deactivate`, { method: 'PATCH' });
                if (result.success) {
                    showNotification('D√ºkkan √ße≈üidi devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±', 'success');
                    loadShopTypes();
                } else {
                    showNotification('Hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Deactivate error:', error);
                showNotification('Deaktifle etme hatasƒ±', 'error');
            }
        }

        async function activateShopType(id) {
            try {
                const result = await API.call(`/shop-types/${id}/activate`, { method: 'PATCH' });
                if (result.success) {
                    showNotification('D√ºkkan √ße≈üidi aktifle≈ütirildi', 'success');
                    loadShopTypes();
                } else {
                    showNotification('Hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Activate error:', error);
                showNotification('Aktifle etme hatasƒ±', 'error');
            }
        }

        function refreshShopTypes() {
            loadShopTypes();
        }

        // Form submission
        document.getElementById('shopTypeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                shopType: document.getElementById('shopTypeCode').value.trim(),
                displayName: document.getElementById('displayName').value.trim(),
                nameTemplate: document.getElementById('nameTemplate').value.trim(),
                purchasePrice: parseInt(document.getElementById('purchasePrice').value),
                rackCapacity: parseInt(document.getElementById('rackCapacity').value),
                storageCapacity: parseInt(document.getElementById('storageCapacity').value),
                minCustomers: parseInt(document.getElementById('minCustomers').value),
                locationType: document.getElementById('locationType').value,
                isActive: document.getElementById('isActive').value === 'true'
            };

            // Validation
            if (!data.shopType || !data.displayName || isNaN(data.purchasePrice) || data.purchasePrice < 1000) {
                showNotification('L√ºtfen t√ºm alanlarƒ± doƒüru doldurun', 'error');
                return;
            }

            try {
                let result;
                if (editingTypeId) {
                    result = await API.put(`/shop-types/${editingTypeId}`, data);
                    if (result.success) showNotification('D√ºkkan √ße≈üidi g√ºncellendi', 'success');
                } else {
                    result = await API.post('/shop-types', data);
                    if (result.success) showNotification('D√ºkkan √ße≈üidi eklendi', 'success');
                }

                if (result.success) {
                    closeModal();
                    loadShopTypes();
                } else {
                    showNotification('Hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Form error:', error);
                showNotification('Bir hata olu≈ütu', 'error');
            }
        });

        // Utility functions
        function showNotification(message, type = 'info') {
            alert(message);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR').format(amount);
        }
    </script>
</body>
</html>
