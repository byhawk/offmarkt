<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffMarket Admin - Pazar Ayarlarƒ±</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
        }

        .setting-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .setting-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .setting-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.15);
        }

        .setting-desc {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 8px;
        }

        .product-price-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .product-emoji {
            font-size: 32px;
        }

        .price-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .control-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .supply-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-top: 10px;
        }

        .supply-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .supply-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f44336);
            transition: width 0.3s;
        }

        .btn-apply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-apply:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->

        <main class="main-content">
            <header class="header">
                <h1>üí∞ Pazar Ayarlarƒ±</h1>
                <div class="header-actions">
                    <button onclick="loadSettings()" class="btn-refresh">üîÑ Yenile</button>
                </div>
            </header>

            <!-- Global Ayarlar -->
            <div class="section">
                <h2>üåç Global Pazar Ayarlarƒ±</h2>
                <div class="settings-grid">
                    <div class="setting-card">
                        <h3>‚è±Ô∏è Fiyat G√ºncelleme Sƒ±klƒ±ƒüƒ±</h3>
                        <input type="number" id="updateFrequency" class="setting-input" value="6" min="1" max="120" step="1">
                        <p class="setting-desc">Ka√ß tick'te bir g√ºncellenecek (1 tick = 5 saniye)<br>
                        √ñrnek: 6 = 30s, 12 = 1dk, 60 = 5dk, 120 = 10dk</p>
                    </div>

                    <div class="setting-card">
                        <h3>üìä Arz-Talep Etkisi</h3>
                        <input type="range" id="demandEffect" class="setting-input" min="0" max="30" value="15" step="1">
                        <p class="setting-desc">Arz-talep dengesinin fiyat √ºzerindeki etkisi: <span id="demandEffectValue">15</span>%</p>
                    </div>

                    <div class="setting-card">
                        <h3>üé≤ Rastgele Volatilite</h3>
                        <input type="range" id="randomVolatility" class="setting-input" min="0" max="20" value="10" step="1">
                        <p class="setting-desc">Rastgele fiyat dalgalanmalarƒ±: <span id="randomVolatilityValue">10</span>%</p>
                    </div>

                    <div class="setting-card">
                        <h3>‚¨ÜÔ∏è Maksimum Fiyat</h3>
                        <input type="number" id="maxPriceMultiplier" class="setting-input" value="2.0" step="0.1" min="1">
                        <p class="setting-desc">Taban fiyatƒ±n ka√ß katƒ±na kadar √ßƒ±kabilir</p>
                    </div>

                    <div class="setting-card">
                        <h3>‚¨áÔ∏è Minimum Fiyat</h3>
                        <input type="number" id="minPriceMultiplier" class="setting-input" value="0.5" step="0.1" min="0.1" max="1">
                        <p class="setting-desc">Taban fiyatƒ±n ka√ß katƒ±na kadar d√º≈üebilir</p>
                    </div>

                    <div class="setting-card">
                        <h3>üîÑ Otomatik G√ºncelleme</h3>
                        <select id="autoUpdate" class="setting-input">
                            <option value="true">Aktif</option>
                            <option value="false">Pasif</option>
                        </select>
                        <p class="setting-desc">TickEngine otomatik fiyat g√ºncellemesi</p>
                    </div>
                </div>

                <button onclick="saveGlobalSettings()" class="btn-apply">üíæ Global Ayarlarƒ± Kaydet</button>
            </div>

            <!-- √úr√ºn Bazlƒ± Ayarlar -->
            <div class="section">
                <h2>üì¶ √úr√ºn Bazlƒ± Fiyat Ayarlarƒ±</h2>
                <div id="productsContainer">
                    <p>Y√ºkleniyor...</p>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        let products = [];
        let globalSettings = {};

        // Range input deƒüer g√∂stergelerini g√ºncelle
        document.getElementById('demandEffect').addEventListener('input', (e) => {
            document.getElementById('demandEffectValue').textContent = e.target.value;
        });

        document.getElementById('randomVolatility').addEventListener('input', (e) => {
            document.getElementById('randomVolatilityValue').textContent = e.target.value;
        });

        async function loadSettings() {
            try {
                // √úr√ºnleri y√ºkle (admin endpoint)
                const productsResult = await API.call('/products');
                if (productsResult && productsResult.success) {
                    products = productsResult.data.products || productsResult.data;
                    renderProducts();
                }

                // Global ayarlarƒ± y√ºkle (backend'den)
                const settingsResult = await API.get('/market-settings');
                if (settingsResult && settingsResult.success) {
                    globalSettings = settingsResult.data.settings;

                    // Form alanlarƒ±nƒ± doldur
                    document.getElementById('updateFrequency').value = globalSettings.updateFrequency || 6;
                    document.getElementById('demandEffect').value = globalSettings.demandEffect || 15;
                    document.getElementById('randomVolatility').value = globalSettings.randomVolatility || 10;
                    document.getElementById('maxPriceMultiplier').value = globalSettings.maxPriceMultiplier || 2.0;
                    document.getElementById('minPriceMultiplier').value = globalSettings.minPriceMultiplier || 0.5;
                    document.getElementById('autoUpdate').value = globalSettings.autoUpdate ? 'true' : 'false';

                    // Slider deƒüerlerini g√ºncelle
                    document.getElementById('demandEffectValue').textContent = globalSettings.demandEffect || 15;
                    document.getElementById('randomVolatilityValue').textContent = globalSettings.randomVolatility || 10;
                }

            } catch (error) {
                console.error('Ayarlar y√ºklenirken hata:', error);
                alert('Ayarlar y√ºklenemedi!');
            }
        }

        function renderProducts() {
            const container = document.getElementById('productsContainer');

            if (!products || products.length === 0) {
                container.innerHTML = '<p>Hi√ß √ºr√ºn bulunamadƒ±.</p>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="product-price-card">
                    <div class="product-header">
                        <div class="product-info">
                            <span class="product-emoji">${product.emoji}</span>
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">${product.name}</h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                                    ${product.category} | Taban: ‚Ç∫${product.basePrice.toFixed(2)}
                                </p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                                ‚Ç∫${product.currentPrice.toFixed(2)}
                            </div>
                            <div style="font-size: 12px; color: ${getPriceChangeColor(product)};">
                                ${getPriceChange(product)}
                            </div>
                        </div>
                    </div>

                    <div class="price-controls">
                        <div class="control-group">
                            <label>Volatilite</label>
                            <input type="number"
                                   id="volatility_${product._id}"
                                   value="${product.volatility}"
                                   step="0.01"
                                   min="0"
                                   max="1">
                        </div>
                        <div class="control-group">
                            <label>Taban Talep (tick)</label>
                            <input type="number"
                                   id="baseDemand_${product._id}"
                                   value="${product.baseDemand}"
                                   min="1"
                                   max="100">
                        </div>
                        <div class="control-group">
                            <label>Mevsimsellik</label>
                            <select id="seasonality_${product._id}">
                                <option value="low" ${product.seasonality === 'low' ? 'selected' : ''}>D√º≈ü√ºk</option>
                                <option value="stable" ${product.seasonality === 'stable' ? 'selected' : ''}>Stabil</option>
                                <option value="high" ${product.seasonality === 'high' ? 'selected' : ''}>Y√ºksek</option>
                            </select>
                        </div>
                    </div>

                    <div class="supply-indicator">
                        <span style="font-size: 12px; font-weight: 600;">Arz Durumu:</span>
                        <div class="supply-bar">
                            <div class="supply-fill" style="width: ${getSupplyPercentage(product)}%"></div>
                        </div>
                        <span style="font-size: 12px; color: #666;">
                            ${getSupplyStatus(product)}
                        </span>
                    </div>

                    <button onclick="updateProduct('${product._id}')" class="btn-apply" style="margin-top: 15px; width: 100%;">
                        üíæ Kaydet
                    </button>
                </div>
            `).join('');
        }

        function getPriceChange(product) {
            const change = ((product.currentPrice - product.basePrice) / product.basePrice) * 100;
            return (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
        }

        function getPriceChangeColor(product) {
            const change = product.currentPrice - product.basePrice;
            return change >= 0 ? '#4CAF50' : '#f44336';
        }

        function getSupplyPercentage(product) {
            // Basit bir supply g√∂stergesi (ger√ßek backend'den gelecek)
            return Math.min((product.baseDemand || 10) * 2, 100);
        }

        function getSupplyStatus(product) {
            const pct = getSupplyPercentage(product);
            if (pct < 30) return '√áok D√º≈ü√ºk ‚¨ÜÔ∏è';
            if (pct < 60) return 'Normal ‚ÜîÔ∏è';
            if (pct < 80) return 'Y√ºksek ‚¨áÔ∏è';
            return 'A≈üƒ±rƒ± Y√ºksek ‚¨áÔ∏è‚¨áÔ∏è';
        }

        async function updateProduct(productId) {
            try {
                const volatility = parseFloat(document.getElementById(`volatility_${productId}`).value);
                const baseDemand = parseInt(document.getElementById(`baseDemand_${productId}`).value);
                const seasonality = document.getElementById(`seasonality_${productId}`).value;

                const result = await API.put(`/products/${productId}`, {
                    volatility,
                    baseDemand,
                    seasonality
                });

                if (result && result.success) {
                    alert('√úr√ºn ayarlarƒ± g√ºncellendi!');
                    loadSettings();
                } else {
                    alert('G√ºncelleme ba≈üarƒ±sƒ±z: ' + (result?.message || 'Bilinmeyen hata'));
                }

            } catch (error) {
                console.error('√úr√ºn g√ºncellenirken hata:', error);
                alert('Hata: ' + error.message);
            }
        }

        async function saveGlobalSettings() {
            try {
                const settingsData = {
                    updateFrequency: parseInt(document.getElementById('updateFrequency').value),
                    demandEffect: parseInt(document.getElementById('demandEffect').value),
                    randomVolatility: parseInt(document.getElementById('randomVolatility').value),
                    maxPriceMultiplier: parseFloat(document.getElementById('maxPriceMultiplier').value),
                    minPriceMultiplier: parseFloat(document.getElementById('minPriceMultiplier').value),
                    autoUpdate: document.getElementById('autoUpdate').value === 'true'
                };

                // Backend'e kaydet
                const result = await API.put('/market-settings', settingsData);

                if (result && result.success) {
                    globalSettings = result.data.settings;
                    alert('‚úÖ Global ayarlar ba≈üarƒ±yla kaydedildi!\n\nDikkat: TickEngine bir sonraki g√ºncellemede bu ayarlarƒ± kullanacak.');
                } else {
                    alert('‚ùå Kaydetme ba≈üarƒ±sƒ±z: ' + (result?.message || 'Bilinmeyen hata'));
                }

            } catch (error) {
                console.error('Global ayarlar kaydedilirken hata:', error);
                alert('‚ùå Hata: ' + error.message);
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.onload = () => {
            loadSettings();
        };
    </script>
</body>
</html>
