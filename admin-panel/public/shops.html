<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffMarket Admin - D√ºkkanlar</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>üéÆ OffMarket</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="nav-menu">
                <a href="/" class="nav-item"><span>üìä</span> Dashboard</a>
                <a href="/players.html" class="nav-item"><span>üë•</span> Oyuncular</a>
                <a href="/products.html" class="nav-item"><span>üì¶</span> √úr√ºnler</a>
                <a href="/shops.html" class="nav-item active"><span>üè™</span> D√ºkkanlar</a>
                <a href="/transactions.html" class="nav-item"><span>üí∞</span> ƒ∞≈ülemler</a>
                <a href="/events.html" class="nav-item"><span>‚ö°</span> Olaylar</a>
                <a href="/banned-words.html" class="nav-item"><span>üö´</span> Yasaklƒ± Kelimeler</a>
                <a href="/analytics.html" class="nav-item"><span>üìà</span> Analitik</a>
            </nav>
            <div class="sidebar-footer">
                <div class="admin-info" id="adminInfo"></div>
                <button onclick="logout()" class="btn-logout">√áƒ±kƒ±≈ü</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>D√ºkkanlar</h1>
                <div class="header-actions">
                    <button onclick="openCreateModal()" class="btn-refresh">‚ûï Yeni D√ºkkan</button>
                    <button onclick="refreshShops()" class="btn-refresh">üîÑ Yenile</button>
                </div>
            </header>

            <div class="filters">
                <select id="statusFilter" onchange="filterShops()">
                    <option value="">T√ºm Durumlar</option>
                    <option value="available">M√ºsait</option>
                    <option value="rented">Kiralƒ±</option>
                </select>
            </div>

            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>D√ºkkan Adƒ±</th>
                                <th>Lokasyon</th>
                                <th>Kira</th>
                                <th>Durum</th>
                                <th>Kiracƒ±</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="shopsTable">
                            <tr><td colspan="6" class="loading">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yeni D√ºkkan</h2>
            <form id="shopForm">
                <div class="form-group">
                    <label>D√ºkkan Adƒ±</label>
                    <input type="text" id="shopName" required>
                </div>
                <div class="form-group">
                    <label>Lokasyon</label>
                    <input type="text" id="shopLocation" required>
                </div>
                <div class="form-group">
                    <label>Kira (G√ºnl√ºk)</label>
                    <input type="number" id="shopRent" min="1" required>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeShopModal()" class="btn-secondary">ƒ∞ptal</button>
                    <button type="submit" class="btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allShops = [];
        let editingShopId = null;

        async function loadShops() {
            const result = await getShops();
            if (result && result.success) {
                allShops = result.data.shops || result.data || [];
                displayShops(allShops);
            }
        }

        function displayShops(shops) {
            const tbody = document.getElementById('shopsTable');
            if (!shops || shops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">D√ºkkan bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = shops.map(shop => `
                <tr>
                    <td><strong>${shop.name}</strong></td>
                    <td>${shop.location}</td>
                    <td>${formatCurrency(shop.rentPerDay)}/g√ºn</td>
                    <td>
                        <span class="badge ${shop.isRented ? 'badge-danger' : 'badge-success'}">
                            ${shop.isRented ? 'Kiralƒ±' : 'M√ºsait'}
                        </span>
                    </td>
                    <td>${shop.currentTenant || '-'}</td>
                    <td>
                        <button onclick="editShop('${shop._id}')" class="btn-sm">D√ºzenle</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterShops() {
            const status = document.getElementById('statusFilter').value;
            let filtered = [...allShops];
            
            if (status === 'available') {
                filtered = filtered.filter(s => !s.isRented);
            } else if (status === 'rented') {
                filtered = filtered.filter(s => s.isRented);
            }
            
            displayShops(filtered);
        }

        function openCreateModal() {
            editingShopId = null;
            document.getElementById('modalTitle').textContent = 'Yeni D√ºkkan';
            document.getElementById('shopForm').reset();
            document.getElementById('shopModal').style.display = 'flex';
        }

        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
            editingShopId = null;
        }

        async function editShop(id) {
            const shop = allShops.find(s => s._id === id);
            if (!shop) return;

            editingShopId = id;
            document.getElementById('modalTitle').textContent = 'D√ºkkan D√ºzenle';
            document.getElementById('shopName').value = shop.name;
            document.getElementById('shopLocation').value = shop.location;
            document.getElementById('shopRent').value = shop.rentPerDay;
            document.getElementById('shopModal').style.display = 'flex';
        }

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('shopName').value,
                location: document.getElementById('shopLocation').value,
                rentPerDay: parseFloat(document.getElementById('shopRent').value)
            };

            let result;
            try {
                if (editingShopId) {
                    result = await updateShop(editingShopId, data);
                } else {
                    result = await createShop(data);
                }

                if (result && result.success) {
                    alert(editingShopId ? 'D√ºkkan g√ºncellendi!' : 'D√ºkkan ba≈üarƒ±yla olu≈üturuldu!');
                    closeShopModal();
                    loadShops();
                } else {
                    alert('Hata: ' + (result?.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
                }
            } catch (error) {
                console.error('Form error:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            }
        });

        function refreshShops() {
            loadShops();
        }

        loadShops();
    </script>
</body>
</html>
