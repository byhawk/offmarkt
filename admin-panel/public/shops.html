<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Baron Admin - Dükkanlar</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar will be loaded by sidebar.js -->

        <main class="main-content">
            <!-- Economic Dashboard Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">🏪</div>
                    <div class="stat-content">
                        <h3 id="total-shops">0</h3>
                        <p>Toplam Dükkan</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🛒</div>
                    <div class="stat-content">
                        <h3 id="rented-shops">0</h3>
                        <p>Kiralı Dükkan</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🤖</div>
                    <div class="stat-content">
                        <h3 id="auto-enabled-shops">0</h3>
                        <p>Otomatik Sistem Açık</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📦</div>
                    <div class="stat-content">
                        <h3 id="total-products">0</h3>
                        <p>Listelenen Ürün</p>
                    </div>
                </div>
            </div>

            <header class="header">
                <h1>Dükkan Yönetimi</h1>
                <div class="header-actions">
                    <a href="/economic-dashboard.html" class="btn-primary">📈 Ekonomik Dashboard'a Git</a>
                    <button onclick="openCreateModal()" class="btn-refresh">➕ Yeni Dükkan</button>
                    <button onclick="refreshShops()" class="btn-refresh">🔄 Yenile</button>
                </div>
            </header>

            <div class="filters">
                <select id="statusFilter" onchange="filterShops()">
                    <option value="">Tüm Durumlar</option>
                    <option value="available">Müsait</option>
                    <option value="rented">Kiralı</option>
                </select>
            </div>

            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Dükkan</th>
                                <th>Konum</th>
                                <th>Sahibi</th>
                                <th>Ürünler</th>
                                <th>Envanter Değeri</th>
                                <th>Otomatik Sistem</th>
                                <th>Stok Durumu</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="shopsTable">
                            <tr><td colspan="7" class="loading">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Shop Detail Modal -->
            <div id="shopDetailModal" class="modal">
                <div class="modal-content large">
                    <h2 id="shopDetailTitle">Dükkan Detayları</h2>
                    <div id="shopDetailContent">
                        <!-- Dinamik içerik JavaScript ile doldurulacak -->
                    </div>
                    <div class="modal-actions">
                        <button onclick="closeShopDetailModal()" class="btn-secondary">Kapat</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yeni Dükkan</h2>
            <form id="shopForm">
                <div class="form-group">
                    <label>Dükkan Türü</label>
                    <select id="shopType" required>
                        <option value="supermarket">🏪 Süpermarket</option>
                        <option value="flower_shop">🌸 Çiçekçi</option>
                        <option value="clothing_store">👕 Kıyafetci</option>
                        <option value="jewelry_store">💎 Mücevherci</option>
                        <option value="food_shop">🍔 Yemekçi</option>
                        <option value="electronics">📱 Elektronikçi</option>
                        <option value="general">🏠 Genel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Dükkan Adı Şablonu</label>
                    <input type="text" id="shopName" placeholder="örn: {ŞEHİR} {TÜR}" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Raf Kapasitesi</label>
                        <input type="number" id="shopRack" placeholder="örn: 2000" min="100" required>
                    </div>
                    <div class="form-group">
                        <label>Aylık Kira Ücreti (₺)</label>
                        <input type="number" id="shopRent" placeholder="örn: 15000" min="100" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Dükkan Resmi</label>
                    <div class="image-upload-group">
                        <input type="file" id="shopImage" accept="image/*">
                        <div id="shopImagePreview" class="image-preview"></div>
                        <button type="button" onclick="uploadShopImage()" class="btn-secondary">📤 Resim Yükle</button>
                    </div>
                    <input type="hidden" id="shopImageUrl">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ülke</label>
                        <select id="shopCountry" required onchange="updateCities()">
                            <option value="">Ülke Seçin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Şehir</label>
                        <select id="shopCity" required>
                            <option value="">Önce Ülke Seçin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeShopModal()" class="btn-secondary">İptal</button>
                    <button type="submit" class="btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allShops = [];
        let editingShopId = null;

        // Ülke ve şehir veritabanı
        const countriesCities = {
            'Türkiye': [
                'İstanbul', 'Ankara', 'İzmir', 'Bursa', 'Antalya', 'Konya', 'Adana', 'Gaziantep', 'Şanlıurfa', 'Kayseri',
                'Mersin', 'Eskişehir', 'Diyarbakır', 'Samsun', 'Denizli', 'Kahramanmaraş', 'Malatya', 'Erzurum', 'Tekirdağ', 'Trabzon'
            ],
            'Almanya': [
                'Berlin', 'Münih', 'Hamburg', 'Köln', 'Frankfurt', 'Stuttgart', 'Düsseldorf', 'Leipzig', 'Dortmund', 'Essen'
            ],
            'Fransa': [
                'Paris', 'Marsilya', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Strazburg', 'Montpellier', 'Bordeaux', 'Lille'
            ],
            'İngiltere': [
                'Londra', 'Birimingham', 'Leeds', 'Glasgow', 'Sheffield', 'Bradford', 'Liverpool', 'Edinburgh', 'Manchester', 'Bristol'
            ],
            'ABD': [
                'New York', 'Los Angeles', 'Chicago', 'Houston', 'Philadelphia', 'Phoenix', 'San Antonio', 'San Diego', 'Dallas', 'San Jose'
            ],
            'Kanada': [
                'Toronto', 'Montreal', 'Vancouver', 'Calgary', 'Edmonton', 'Ottawa', 'Winnipeg', 'Quebec', 'Hamilton', 'Kitchener'
            ],
            'İtalya': [
                'Roma', 'Milano', 'Napoli', 'Torino', 'Palermo', 'Cenova', 'Bologna', 'Floransa', 'Venedik', 'Verona'
            ],
            'İspanya': [
                'Madrid', 'Barselona', 'Valencia', 'Sevilla', 'Zaragoza', 'Malaga', 'Murcia', 'Palma', 'Las Palmas', 'Bilbao'
            ],
            'Japonya': [
                'Tokyo', 'Yokohama', 'Osaka', 'Nagoya', 'Sapporo', 'Kobe', 'Kawasaki', 'Fukuoka', 'Saitama', 'Hiroshima'
            ],
            'Güney Kore': [
                'Seul', 'Busan', 'Incheon', 'Daegu', 'Daejeon', 'Gwangju', 'Suwon', 'Ulsan', 'Changwon', 'Goyang'
            ],
            'Çin': [
                'Şanghay', 'Pekin', 'Şenzhen', 'Guangzhou', 'Dongguan', 'Tianjin', 'Suzhou', 'Foshan', 'Zhejiang', 'Hangzhou'
            ],
            'Brezilya': [
                'São Paulo', 'Rio de Janeiro', 'Brasilia', 'Salvador', 'Fortaleza', 'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'Goiânia'
            ],
            'Meksika': [
                'Mexico City', 'Guadalajara', 'Monterrey', 'Leon', 'Puebla', 'Tijuana', 'Juarez', 'Cancun', 'Mérida', 'Querétaro'
            ],
            'Avustralya': [
                'Sidney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Gold Coast', 'Cairns', 'Newcastle', 'Darwin', 'Townsville'
            ],
            'Hindistan': [
                'Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Ahmedabad', 'Chennai', 'Kolkata', 'Surat', 'Pune', 'Jaipur'
            ]
        };

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeCountrySelect();
            loadShopsData();
        });

        // Ülkeler dropdown'ını başlat
        function initializeCountrySelect() {
            const countrySelect = document.getElementById('shopCountry');
            Object.keys(countriesCities).forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        // Şehir dropdown'ını güncelle
        function updateCities() {
            const country = document.getElementById('shopCountry').value;
            const citySelect = document.getElementById('shopCity');

            // Mevcut şehirleri temizle
            citySelect.innerHTML = '';

            if (country && countriesCities[country]) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Şehir Seçin';
                citySelect.appendChild(defaultOption);

                countriesCities[country].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });

                citySelect.disabled = false;
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Önce Ülke Seçin';
                citySelect.appendChild(defaultOption);
                citySelect.disabled = true;
            }
        }

        async function loadShopsData() {
            try {
                // Ekonomik istatistikleri al
                const dashboardResult = await API.call('/admin/economic-dashboard');
                if (dashboardResult.success) {
                    updateEconomicStats(dashboardResult.data.marketOverview);
                }

                // Detaylı dükkan bilgilerini al
                const shopsResult = await API.call('/admin/shops/detailed');
                if (shopsResult.success) {
                    allShops = shopsResult.data.shops || [];
                    displayShops(allShops);
                }
            } catch (error) {
                console.error('Veri yükleme hatası:', error);
                showNotification('Veriler yüklenirken hata oluştu', 'error');
            }
        }

        function updateEconomicStats(stats) {
            document.getElementById('total-shops').textContent = stats.totalShops;
            document.getElementById('rented-shops').textContent =
                stats.totalShops - allShops.filter(s => s.isAvailable).length;
            document.getElementById('auto-enabled-shops').textContent =
                allShops.filter(s => s.economicMetrics?.autoPurchaseEnabled).length;
            document.getElementById('total-products').textContent = stats.totalListedProducts;
        }

        function displayShops(shops) {
            const tbody = document.getElementById('shopsTable');
            if (!shops || shops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Dükkan bulunamadı</td></tr>';
                return;
            }

            tbody.innerHTML = shops.map(shop => {
                const metrics = shop.economicMetrics || {};
                const ownerName = shop.rentedBy?.username || 'Kirada';
                const isRented = !shop.isAvailable;
                const locationDisplay = `${shop.country || 'Bilinmiyor'}/${shop.city || 'Bilinmiyor'}`;

                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${shop.name}</strong>
                                <br>
                                <small class="text-muted">${shop.location}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <span class="badge badge-info">${locationDisplay}</span>
                            </div>
                        </td>
                        <td>${ownerName}</td>
                        <td>${metrics.listedProductsCount || 0}</td>
                        <td>₺${formatCurrency(metrics.totalListedValue || 0)}</td>
                        <td>
                            <span class="badge ${metrics.autoPurchaseEnabled ? 'success' : 'secondary'}">
                                ${metrics.autoPurchaseEnabled ? 'Aktif' : 'Pasif'}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-direction: column;">
                                ${getStockStatusIndicators(metrics)}
                            </div>
                        </td>
                        <td>
                            ${getShopActions(shop, isRented)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStockStatusIndicators(metrics) {
            if (!metrics.listedProductsCount) return '<small class="text-muted">Ürün yok</small>';

            const lowStock = metrics.lowStockProducts || 0;
            const highStock = metrics.highStockProducts || 0;

            return `
                <small class="${lowStock > 0 ? 'text-danger' : 'text-muted'}">
                    Düşük stok: ${lowStock}
                </small>
                <small class="${highStock > 0 ? 'text-warning' : 'text-muted'}">
                    Fazla stok: ${highStock}
                </small>
            `;
        }

        function getShopActions(shop, isRented) {
            let actions = `<button onclick="viewShopDetails('${shop._id}')" class="btn-sm primary">🔍 Detay</button>`;

            if (isRented && shop.rentedBy) {
                actions += `
                    <button onclick="resetShopInventory('${shop._id}')" class="btn-sm danger">
                        🗑️ Envanter Sıfırla
                    </button>
                    <button onclick="manageAutoSettings('${shop._id}')" class="btn-sm secondary">
                        ⚙️ Otomatik
                    </button>
                `;
            }

            actions += `<button onclick="editShop('${shop._id}')" class="btn-sm">✏️ Düzenle</button>`;
            return actions;
        }

        function filterShops() {
            const status = document.getElementById('statusFilter').value;
            let filtered = [...allShops];

            if (status === 'available') {
                filtered = filtered.filter(s => s.isAvailable);
            } else if (status === 'rented') {
                filtered = filtered.filter(s => !s.isAvailable);
            }

            displayShops(filtered);
        }

        // === SHOP MANAGEMENT FUNCTIONS ===

        async function viewShopDetails(shopId) {
            try {
                const result = await API.call(`/admin/shops/${shopId}/listed-products`);
                if (result.success) {
                    showShopDetailModal(result.data);
                }
            } catch (error) {
                console.error('Shop detail error:', error);
                showNotification('Dükkan detayları alınamadı', 'error');
            }
        }

        function showShopDetailModal(shopData) {
            const shop = shopData.shopInfo;
            const products = shopData.listedProducts;
            const summary = shopData.summary;

            let content = `
                <div class="shop-detail-header">
                    <h3>${shop.name}</h3>
                    <p>${shop.location}</p>
                    <p><strong>Sahibi:</strong> ${shop.owner?.username || 'Kirada'}</p>
                    <p><strong>Otomatik Sistem:</strong>
                        <span class="badge ${shop.autoPurchaseSettings?.enableBalanceControl ? 'success' : 'secondary'}">
                            ${shop.autoPurchaseSettings?.enableBalanceControl ? 'Aktif' : 'Pasif'}
                        </span>
                    </p>
                </div>

                <div class="shop-detail-metrics">
                    <div class="metric-item">
                        <strong>Toplam Ürün:</strong> ${summary.totalProducts}
                    </div>
                    <div class="metric-item">
                        <strong>Envanter Değeri:</strong> ₺${formatCurrency(summary.totalStockValue)}
                    </div>
                    <div class="metric-item">
                        <strong>Düşük Stok Ürünleri:</strong> ${summary.lowStockProducts}
                    </div>
                </div>

                <h4>Listelenen Ürünler</h4>
                ${products.length > 0 ? `
                    <table class="data-table" style="margin-top: 10px;">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th>Stok</th>
                                <th>Fiyat</th>
                                <th>Satış</th>
                                <th>Oto. Alım</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => `
                                <tr>
                                    <td>${product.product.name}</td>
                                    <td>${product.currentStock}/${product.maxStock}</td>
                                    <td>₺${formatCurrency(product.listPrice)}</td>
                                    <td>${product.totalSold}</td>
                                    <td>
                                        <span class="badge ${product.autoPurchase ? 'success' : 'secondary'}">
                                            ${product.autoPurchase ? 'Evet' : 'Hayır'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="no-data">Bu dükkanda henüz ürün listelenmemiş.</p>'}
            `;

            document.getElementById('shopDetailTitle').textContent = `${shop.name} - Detaylar`;
            document.getElementById('shopDetailContent').innerHTML = content;
            document.getElementById('shopDetailModal').style.display = 'flex';
        }

        function closeShopDetailModal() {
            document.getElementById('shopDetailModal').style.display = 'none';
        }

        async function resetShopInventory(shopId) {
            if (!confirm('Bu dükkanın tüm envanterini sıfırlamak istediğinize emin misiniz?')) return;

            try {
                const result = await API.call(`/admin/shops/${shopId}/reset-inventory`, 'POST');
                if (result.success) {
                    showNotification('Dükkan envanteri sıfırlandı', 'success');
                    loadShopsData();
                }
            } catch (error) {
                console.error('Reset inventory error:', error);
                showNotification('Envanter sıfırlama başarısız', 'error');
            }
        }

        async function manageAutoSettings(shopId) {
            // For now, redirect to economic dashboard for advanced settings
            window.location.href = `/economic-dashboard.html`;
        }

        // === STANDARD CRUD FUNCTIONS ===

        function openCreateModal() {
            editingShopId = null;
            document.getElementById('modalTitle').textContent = 'Yeni Dükkan';
            document.getElementById('shopForm').reset();
            document.getElementById('shopModal').style.display = 'flex';
        }

        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
            editingShopId = null;
        }

        async function editShop(id) {
            const shop = allShops.find(s => s._id === id);
            if (!shop) return;

            editingShopId = id;
            document.getElementById('modalTitle').textContent = 'Dükkan Düzenle';
            document.getElementById('shopCountry').value = shop.country || '';
            document.getElementById('shopCity').value = shop.city || '';
            document.getElementById('shopName').value = shop.name;
            document.getElementById('shopStorage').value = shop.squareMeters || 75;
            document.getElementById('shopLocation').value = shop.location;
            document.getElementById('shopRent').value = shop.monthlyRent || 15000;
            document.getElementById('shopModal').style.display = 'flex';
        }

        function refreshShops() {
            loadShopsData();
        }

        // === FORM HANDLING ===

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                country: document.getElementById('shopCountry').value.trim(),
                city: document.getElementById('shopCity').value.trim(),
                name: document.getElementById('shopName').value.trim(),
                location: document.getElementById('shopStorage').value.trim() + 'm² Depo',
                monthlyRent: parseFloat(document.getElementById('shopRent').value),
                deposit: parseFloat(document.getElementById('shopRent').value) * 2, // 2 ay depozito
                squareMeters: parseInt(document.getElementById('shopStorage').value),
                locationType: 'street', // Default
                isActive: true
            };

            if (!data.country || !data.city || !data.name || !data.squareMeters || isNaN(data.monthlyRent)) {
                showNotification('Lütfen tüm alanları doldurun', 'error');
                return;
            }

            try {
                let result;
                if (editingShopId) {
                    result = await API.call(`/admin/shops/${editingShopId}`, 'PUT', data);
                    if (result.success) showNotification('Dükkan güncellendi', 'success');
                } else {
                    result = await API.call('/admin/shops', 'POST', data);
                    if (result.success) showNotification('Dükkan oluşturuldu', 'success');
                }

                if (result.success) {
                    closeShopModal();
                    loadShopsData();
                } else {
                    showNotification(result.message || 'İşlem başarısız', 'error');
                }
            } catch (error) {
                console.error('Shop form error:', error);
                showNotification('Bir hata oluştu', 'error');
            }
        });

        // === UTILITY FUNCTIONS ===

        function showNotification(message, type = 'info') {
            // Simple notification - you could enhance this
            alert(message);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR').format(amount);
        }

        // Resim yükleme fonksiyonları
        document.getElementById('shopImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('shopImagePreview').innerHTML = 
                        `<img src="${event.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        async function uploadShopImage() {
            const fileInput = document.getElementById('shopImage');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Lütfen bir resim seçin');
                return;
            }

            const result = await uploadImage(file, 'shops');
            if (result && result.success) {
                document.getElementById('shopImageUrl').value = result.imageUrl;
                alert('Resim başarıyla yüklendi!');
            } else {
                alert('Resim yükleme başarısız: ' + (result?.message || 'Bilinmeyen hata'));
            }
        }
    </script>
</body>
</html>
