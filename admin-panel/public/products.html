<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Baron Admin - ÃœrÃ¼nler</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar will be loaded by sidebar.js -->

        <main class="main-content">
            <header class="header">
                <h1>ÃœrÃ¼nler</h1>
                <div class="header-actions">
                    <button onclick="openCreateModal()" class="btn-refresh">âž• Yeni ÃœrÃ¼n</button>
                    <button onclick="refreshProducts()" class="btn-refresh">ðŸ”„ Yenile</button>
                </div>
            </header>

            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÃœrÃ¼n AdÄ±</th>
                                <th>Kategori</th>
                                <th>Taban Fiyat</th>
                                <th>Mevcut Fiyat</th>
                                <th>Pazar Durumu</th>
                                <th>DÃ¼kkan SayÄ±sÄ±</th>
                                <th>Volatilite</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr><td colspan="8" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yeni ÃœrÃ¼n</h2>
            <form id="productForm">
                <div class="form-group">
                    <label>ÃœrÃ¼n AdÄ±</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="productCategory" required>
                        <option value="electronics">Elektronik</option>
                        <option value="clothing">Giyim</option>
                        <option value="food">GÄ±da</option>
                        <option value="furniture">Mobilya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Taban Fiyat</label>
                    <input type="number" id="productBasePrice" min="1" required>
                </div>
                <div class="form-group">
                    <label>ÃœrÃ¼n Resmi</label>
                    <div class="image-upload-group">
                        <input type="file" id="productImage" accept="image/*">
                        <div id="imagePreview" class="image-preview"></div>
                        <button type="button" onclick="uploadProductImage()" class="btn-secondary">ðŸ“¤ Resim YÃ¼kle</button>
                    </div>
                    <input type="hidden" id="productImageUrl">
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeProductModal()" class="btn-secondary">Ä°ptal</button>
                    <button type="submit" class="btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allProducts = [];
        let productEconomics = {};
        let editingProductId = null;

        async function loadProducts() {
            try {
                // Ana Ã¼rÃ¼n verileri
                const result = await getProducts();
                if (result && result.success) {
                    allProducts = result.data.products || result.data || [];
                }

                // Ekonomik analiz verileri
                const marketResult = await API.call('/admin/market/supply-demand-analysis');
                if (marketResult && marketResult.success) {
                    marketResult.data.analyses.forEach(analysis => {
                        productEconomics[analysis.productId] = {
                            supplyRatio: analysis.supplyRatio,
                            demandLevel: analysis.demandLevel,
                            totalListed: analysis.totalListed,
                            shopCount: analysis.shopListings?.length || 0
                        };
                    });
                }

                displayProducts(allProducts);
            } catch (error) {
                console.error('Products load error:', error);
                displayProducts(allProducts); // Hata olsa da temel Ã¼rÃ¼nleri gÃ¶ster
            }
        }

        function displayProducts(products) {
            const tbody = document.getElementById('productsTable');
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">ÃœrÃ¼n bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                const economy = productEconomics[product._id] || {};
                const marketHealth = getMarketHealth(economy.supplyRatio, economy.demandLevel);
                const shopCount = economy.shopCount || 0;

                return `
                    <tr>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.emoji ? product.emoji : 'ðŸ“¦'}
                        </td>
                        <td><span class="badge secondary">${product.category}</span></td>
                        <td>${formatCurrency(product.basePrice)}</td>
                        <td>${formatCurrency(product.currentPrice)}</td>
                        <td>
                            <span class="badge ${getMarketStatusClass(marketHealth.status)}">
                                ${marketHealth.label}
                            </span>
                        </td>
                        <td>${shopCount}</td>
                        <td>${(product.volatility * 100).toFixed(1)}%</td>
                        <td>
                            <button onclick="toggleProductActiveAction('${product._id}')" class="btn-sm ${product.isActive ? 'btn-danger' : 'btn-success'}">
                                ${product.isActive ? 'ðŸš« Pazardan Ã‡Ä±kar' : 'âœ… Pazara Ekle'}
                            </button>
                            <button onclick="editProduct('${product._id}')" class="btn-sm">DÃ¼zenle</button>
                            <button onclick="viewProductAnalysis('${product._id}')" class="btn-sm primary">ðŸ“Š Analiz</button>
                            <button onclick="deleteProductAction('${product._id}')" class="btn-sm btn-danger">Sil</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getMarketHealth(supplyRatio, demandLevel) {
            if (!supplyRatio) return { status: 'unknown', label: 'Belirsiz' };

            if (supplyRatio < 0.5) {
                return { status: 'danger', label: 'Ã‡ok Az Arz' };
            } else if (supplyRatio > 2.0) {
                return { status: 'warning', label: 'Ã‡ok Fazla Arz' };
            } else if (demandLevel === 'very_high' || demandLevel === 'high') {
                return { status: 'success', label: 'YÃ¼ksek Talep' };
            } else {
                return { status: 'primary', label: 'Dengeli' };
            }
        }

        function getMarketStatusClass(status) {
            switch (status) {
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'danger': return 'danger';
                default: return 'secondary';
            }
        }

        function viewProductAnalysis(productId) {
            // Ekonomik dashboard'a yÃ¶nlendir, belirli Ã¼rÃ¼n iÃ§in filtre uygulayarak
            window.location.href = `/economic-dashboard.html?product=${productId}`;
        }

        function openCreateModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Yeni ÃœrÃ¼n';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        async function editProduct(id) {
            const product = allProducts.find(p => p._id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'ÃœrÃ¼n DÃ¼zenle';
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productBasePrice').value = product.basePrice;
            document.getElementById('productModal').style.display = 'flex';
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                basePrice: parseFloat(document.getElementById('productBasePrice').value)
            };

            let result;
            try {
                if (editingProductId) {
                    result = await updateProduct(editingProductId, data);
                } else {
                    result = await createProduct(data);
                }

                if (result && result.success) {
                    alert(editingProductId ? 'ÃœrÃ¼n gÃ¼ncellendi!' : 'ÃœrÃ¼n baÅŸarÄ±yla oluÅŸturuldu!');
                    closeProductModal();
                    loadProducts();
                } else {
                    alert('Hata: ' + (result?.message || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z'));
                }
            } catch (error) {
                console.error('Form error:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            }
        });

        async function toggleProductActiveAction(id) {
            const result = await toggleProductActive(id);
            if (result && result.success) {
                alert(result.message);
                loadProducts();
            } else {
                alert('Hata: ' + (result?.message || 'Ä°ÅŸlem baÅŸarÄ±sÄ±z'));
            }
        }

        async function deleteProductAction(id) {
            if (!confirm('Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?')) return;
            
            const result = await deleteProduct(id);
            if (result && result.success) {
                alert('ÃœrÃ¼n silindi');
                loadProducts();
            }
        }

        function refreshProducts() {
            loadProducts();
        }

        // Resim yÃ¼kleme fonksiyonlarÄ±
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('imagePreview').innerHTML = 
                        `<img src="${event.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        async function uploadProductImage() {
            const fileInput = document.getElementById('productImage');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('LÃ¼tfen bir resim seÃ§in');
                return;
            }

            const result = await uploadImage(file, 'products');
            if (result && result.success) {
                document.getElementById('productImageUrl').value = result.imageUrl;
                alert('Resim baÅŸarÄ±yla yÃ¼klendi!');
            } else {
                alert('Resim yÃ¼kleme baÅŸarÄ±sÄ±z: ' + (result?.message || 'Bilinmeyen hata'));
            }
        }

        loadProducts();
    </script>
</body>
</html>
