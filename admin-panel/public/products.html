<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffMarket Admin - √úr√ºnler</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>OffMarket Admin</h2>
                <p>Y√∂netim Paneli</p>
            </div>
            <nav class="nav-menu">
                <a href="/" class="nav-item"><span>üìä</span> Dashboard</a>
                <a href="/players.html" class="nav-item"><span>üë•</span> Oyuncular</a>
                <a href="/products.html" class="nav-item active"><span>üì¶</span> √úr√ºnler</a>
                <a href="/shops.html" class="nav-item"><span>üè™</span> D√ºkkanlar</a>
                <a href="/transactions.html" class="nav-item"><span>üí∞</span> ƒ∞≈ülemler</a>
                <a href="/events.html" class="nav-item"><span>‚ö°</span> Olaylar</a>
                <a href="/economic-dashboard.html" class="nav-item"><span>üìà</span> Ekonomi</a>
                <a href="/analytics.html" class="nav-item"><span>üìä</span> Analitik</a>
                <a href="/banned-words.html" class="nav-item"><span>üö´</span> Yasaklƒ± Kelimeler</a>
            </nav>
            <div class="sidebar-footer">
                <div class="admin-info" id="adminInfo"></div>
                <button onclick="logout()" class="btn-logout">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>√úr√ºnler</h1>
                <div class="header-actions">
                    <button onclick="openCreateModal()" class="btn-refresh">‚ûï Yeni √úr√ºn</button>
                    <button onclick="refreshProducts()" class="btn-refresh">üîÑ Yenile</button>
                </div>
            </header>

            <div class="section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>√úr√ºn Adƒ±</th>
                                <th>Kategori</th>
                                <th>Taban Fiyat</th>
                                <th>Mevcut Fiyat</th>
                                <th>Pazar Durumu</th>
                                <th>D√ºkkan Sayƒ±sƒ±</th>
                                <th>Volatilite</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr><td colspan="8" class="loading">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yeni √úr√ºn</h2>
            <form id="productForm">
                <div class="form-group">
                    <label>√úr√ºn Adƒ±</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="productCategory" required>
                        <option value="electronics">Elektronik</option>
                        <option value="clothing">Giyim</option>
                        <option value="food">Gƒ±da</option>
                        <option value="furniture">Mobilya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Taban Fiyat</label>
                    <input type="number" id="productBasePrice" min="1" required>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeProductModal()" class="btn-secondary">ƒ∞ptal</button>
                    <button type="submit" class="btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        let allProducts = [];
        let productEconomics = {};
        let editingProductId = null;

        async function loadProducts() {
            try {
                // Ana √ºr√ºn verileri
                const result = await getProducts();
                if (result && result.success) {
                    allProducts = result.data.products || result.data || [];
                }

                // Ekonomik analiz verileri
                const marketResult = await API.call('/admin/market/supply-demand-analysis');
                if (marketResult && marketResult.success) {
                    marketResult.data.analyses.forEach(analysis => {
                        productEconomics[analysis.productId] = {
                            supplyRatio: analysis.supplyRatio,
                            demandLevel: analysis.demandLevel,
                            totalListed: analysis.totalListed,
                            shopCount: analysis.shopListings?.length || 0
                        };
                    });
                }

                displayProducts(allProducts);
            } catch (error) {
                console.error('Products load error:', error);
                displayProducts(allProducts); // Hata olsa da temel √ºr√ºnleri g√∂ster
            }
        }

        function displayProducts(products) {
            const tbody = document.getElementById('productsTable');
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">√úr√ºn bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                const economy = productEconomics[product._id] || {};
                const marketHealth = getMarketHealth(economy.supplyRatio, economy.demandLevel);
                const shopCount = economy.shopCount || 0;

                return `
                    <tr>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.emoji ? product.emoji : 'üì¶'}
                        </td>
                        <td><span class="badge secondary">${product.category}</span></td>
                        <td>${formatCurrency(product.basePrice)}</td>
                        <td>${formatCurrency(product.currentPrice)}</td>
                        <td>
                            <span class="badge ${getMarketStatusClass(marketHealth.status)}">
                                ${marketHealth.label}
                            </span>
                        </td>
                        <td>${shopCount}</td>
                        <td>${(product.volatility * 100).toFixed(1)}%</td>
                        <td>
                            <button onclick="toggleProductActiveAction('${product._id}')" class="btn-sm ${product.isActive ? 'btn-danger' : 'btn-success'}">
                                ${product.isActive ? 'üö´ Pazardan √áƒ±kar' : '‚úÖ Pazara Ekle'}
                            </button>
                            <button onclick="editProduct('${product._id}')" class="btn-sm">D√ºzenle</button>
                            <button onclick="viewProductAnalysis('${product._id}')" class="btn-sm primary">üìä Analiz</button>
                            <button onclick="deleteProductAction('${product._id}')" class="btn-sm btn-danger">Sil</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getMarketHealth(supplyRatio, demandLevel) {
            if (!supplyRatio) return { status: 'unknown', label: 'Belirsiz' };

            if (supplyRatio < 0.5) {
                return { status: 'danger', label: '√áok Az Arz' };
            } else if (supplyRatio > 2.0) {
                return { status: 'warning', label: '√áok Fazla Arz' };
            } else if (demandLevel === 'very_high' || demandLevel === 'high') {
                return { status: 'success', label: 'Y√ºksek Talep' };
            } else {
                return { status: 'primary', label: 'Dengeli' };
            }
        }

        function getMarketStatusClass(status) {
            switch (status) {
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'danger': return 'danger';
                default: return 'secondary';
            }
        }

        function viewProductAnalysis(productId) {
            // Ekonomik dashboard'a y√∂nlendir, belirli √ºr√ºn i√ßin filtre uygulayarak
            window.location.href = `/economic-dashboard.html?product=${productId}`;
        }

        function openCreateModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Yeni √úr√ºn';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        async function editProduct(id) {
            const product = allProducts.find(p => p._id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modalTitle').textContent = '√úr√ºn D√ºzenle';
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productBasePrice').value = product.basePrice;
            document.getElementById('productModal').style.display = 'flex';
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                basePrice: parseFloat(document.getElementById('productBasePrice').value)
            };

            let result;
            try {
                if (editingProductId) {
                    result = await updateProduct(editingProductId, data);
                } else {
                    result = await createProduct(data);
                }

                if (result && result.success) {
                    alert(editingProductId ? '√úr√ºn g√ºncellendi!' : '√úr√ºn ba≈üarƒ±yla olu≈üturuldu!');
                    closeProductModal();
                    loadProducts();
                } else {
                    alert('Hata: ' + (result?.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
                }
            } catch (error) {
                console.error('Form error:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            }
        });

        async function toggleProductActiveAction(id) {
            const result = await toggleProductActive(id);
            if (result && result.success) {
                alert(result.message);
                loadProducts();
            } else {
                alert('Hata: ' + (result?.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
            }
        }

        async function deleteProductAction(id) {
            if (!confirm('Bu √ºr√ºn√º silmek istediƒüinizden emin misiniz?')) return;
            
            const result = await deleteProduct(id);
            if (result && result.success) {
                alert('√úr√ºn silindi');
                loadProducts();
            }
        }

        function refreshProducts() {
            loadProducts();
        }

        loadProducts();
    </script>
</body>
</html>
