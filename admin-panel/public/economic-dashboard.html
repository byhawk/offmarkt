<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffMarkt - Ekonomik Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¢ OffMarkt Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/index.html">ğŸ“Š Dashboard</a></li>
                <li><a href="/players.html">ğŸ‘¥ Oyuncular</a></li>
                <li><a href="/products.html">ğŸ“¦ ÃœrÃ¼nler</a></li>
                <li><a href="/shops.html">ğŸª DÃ¼kkanlar</a></li>
                <li><a href="/transactions.html">ğŸ’° Ä°ÅŸlemler</a></li>
                <li><a href="/events.html">ğŸ¯ Olaylar</a></li>
                <li><a href="/economic-dashboard.html" class="active">ğŸ“ˆ Ekonomi</a></li>
                <li><a href="/analytics.html">ğŸ“Š Analitik</a></li>
                <li><a href="/banned-words.html">ğŸš« YasaklÄ± Kelimeler</a></li>
                <li><a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>ğŸ“ˆ Ekonomik Sistem Dashboard</h1>
                <div class="header-actions">
                    <button onclick="loadEconomicData()" class="btn-primary">ğŸ“Š Yenile</button>
                </div>
            </header>

            <!-- Market Overview Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸª</div>
                    <div class="stat-content">
                        <h3 id="total-shops">0</h3>
                        <p>Toplam DÃ¼kkan</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ¤–</div>
                    <div class="stat-content">
                        <h3 id="auto-purchase-shops">0</h3>
                        <p>Otomatik Sistem AÃ§Ä±k</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-content">
                        <h3 id="total-listed-products">0</h3>
                        <p>Listelenen ÃœrÃ¼n</p>
                    </div>
                </div>
                <div class="stat-card" id="market-health-card">
                    <div class="stat-icon">â¤ï¸</div>
                    <div class="stat-content">
                        <h3 id="market-health">N/A</h3>
                        <p>Pazar SaÄŸlÄ±ÄŸÄ±</p>
                    </div>
                </div>
            </section>

            <div class="content-grid">
                <!-- Market Analysis -->
                <section class="content-section">
                    <div class="section-header">
                        <h2>ğŸ“Š Arz/Talep Analizi</h2>
                        <button onclick="runGlobalPriceAdjustment()" class="btn-secondary">âš–ï¸ Fiyat Dengele</button>
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ÃœrÃ¼n</th>
                                    <th>Arz/Oran</th>
                                    <th>Kategori</th>
                                    <th>Toplam Stok</th>
                                    <th>Fiyat Tavsiyesi</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="supply-demand-table">
                                <tr><td colspan="6" class="loading">Veriler yÃ¼kleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Shop Performance -->
                <section class="content-section">
                    <div class="section-header">
                        <h2>ğŸª DÃ¼kkan PerformansÄ±</h2>
                        <button onclick="loadShopPerformance()" class="btn-secondary">ğŸ“Š Yenile</button>
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>DÃ¼kkan</th>
                                    <th>Sahibi</th>
                                    <th>ÃœrÃ¼n SayÄ±sÄ±</th>
                                    <th>Toplam DeÄŸer</th>
                                    <th>Otomatik Sistem</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="shop-performance-table">
                                <tr><td colspan="6" class="loading">Veriler yÃ¼kleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Recent Price Adjustments -->
            <section class="content-section">
                <div class="section-header">
                    <h2>ğŸ’° Son Fiyat DeÄŸiÅŸiklikleri</h2>
                </div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>DÃ¼kkan</th>
                                <th>ÃœrÃ¼n</th>
                                <th>Eski Fiyat</th>
                                <th>Yeni Fiyat</th>
                                <th>Neden</th>
                            </tr>
                        </thead>
                        <tbody id="price-adjustments-table">
                            <tr><td colspan="6" class="no-data">HenÃ¼z fiyat deÄŸiÅŸikliÄŸi yok</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="loading-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p>Ä°ÅŸlem gerÃ§ekleÅŸtiriliyor...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadEconomicData();
        });

        async function loadEconomicData() {
            try {
                showLoading();
                const response = await API.call('/admin/economic-dashboard');

                if (response.success) {
                    updateMarketOverview(response.data.marketOverview);
                    updateSupplyDemandTable(response.data.supplyDemandAnalysis);
                    updateShopPerformance(response.data.shopPerformance);
                    updateRecentAdjustments(response.data.recentPriceAdjustments);
                }
            } catch (error) {
                console.error('Economic data error:', error);
                alert('Veriler yÃ¼klenirken hata oluÅŸtu');
            } finally {
                hideLoading();
            }
        }

        function updateMarketOverview(overview) {
            document.getElementById('total-shops').textContent = overview.totalShops;
            document.getElementById('auto-purchase-shops').textContent = overview.shopsWithAutoPurchase;
            document.getElementById('total-listed-products').textContent = overview.totalListedProducts;

            const healthCard = document.getElementById('market-health-card');
            const healthElement = document.getElementById('market-health');

            if (overview.marketHealth === 'healthy') {
                healthCard.className = 'stat-card success';
                healthElement.textContent = 'SaÄŸlÄ±klÄ±';
            } else if (overview.marketHealth === 'unbalanced') {
                healthCard.className = 'stat-card warning';
                healthElement.textContent = 'Dengesiz';
            } else {
                healthCard.className = 'stat-card danger';
                healthElement.textContent = 'Riskli';
            }
        }

        function updateSupplyDemandTable(analysis) {
            const tbody = document.getElementById('supply-demand-table');
            const analyses = analysis.analyses.slice(0, 10); // Ä°lk 10 Ã¼rÃ¼nÃ¼ gÃ¶ster

            tbody.innerHTML = analyses.map(item => `
                <tr>
                    <td>${item.productName}</td>
                    <td>${item.supplyRatio.toFixed(2)}</td>
                    <td><span class="badge ${getDemandLevelClass(item.demandLevel)}">${getDemandLevelText(item.demandLevel)}</span></td>
                    <td>${item.totalListed}</td>
                    <td>${item.analysis?.recommendation || 'Analiz ediliyor...'}</td>
                    <td>
                        <button onclick="viewProductAnalysis('${item.productId}')" class="btn-small">Detay</button>
                    </td>
                </tr>
            `).join('');

            if (analyses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">HenÃ¼z Ã¼rÃ¼n analizi yok</td></tr>';
            }
        }

        function updateShopPerformance(shops) {
            const tbody = document.getElementById('shop-performance-table');

            tbody.innerHTML = shops.map(shop => `
                <tr>
                    <td>${shop.shopName}</td>
                    <td>${shop.owner?.username || 'Kirada'}</td>
                    <td>${shop.listedProductsCount}</td>
                    <td>â‚º${shop.totalStockValue.toLocaleString()}</td>
                    <td>
                        <span class="badge ${shop.autoPurchaseEnabled ? 'success' : 'secondary'}">
                            ${shop.autoPurchaseEnabled ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td>
                        <button onclick="viewShopDetails('${shop.shopId}')" class="btn-small">Detay</button>
                        ${shop.owner ? `<button onclick="resetShopInventory('${shop.shopId}')" class="btn-small danger">SÄ±fÄ±rla</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentAdjustments(adjustments) {
            const tbody = document.getElementById('price-adjustments-table');

            if (!adjustments || adjustments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">HenÃ¼z fiyat deÄŸiÅŸikliÄŸi yok</td></tr>';
                return;
            }

            tbody.innerHTML = adjustments.map(adj => `
                <tr>
                    <td>${new Date(adj.timestamp).toLocaleDateString('tr-TR')}</td>
                    <td>${adj.shopName}</td>
                    <td>${adj.productName}</td>
                    <td>â‚º${adj.oldPrice}</td>
                    <td>â‚º${adj.newPrice}</td>
                    <td><span class="badge secondary">${getAdjustmentReasonText(adj.reason)}</span></td>
                </tr>
            `).join('');
        }

        function getDemandLevelClass(level) {
            switch (level) {
                case 'very_high': return 'success';
                case 'high': return 'success';
                case 'balanced': return 'primary';
                case 'low': return 'warning';
                case 'very_low': return 'danger';
                default: return 'secondary';
            }
        }

        function getDemandLevelText(level) {
            switch (level) {
                case 'very_high': return 'Ã‡ok YÃ¼ksek';
                case 'high': return 'YÃ¼ksek';
                case 'balanced': return 'Dengeli';
                case 'low': return 'DÃ¼ÅŸÃ¼k';
                case 'very_low': return 'Ã‡ok DÃ¼ÅŸÃ¼k';
                default: return level;
            }
        }

        function getAdjustmentReasonText(reason) {
            switch (reason) {
                case 'supply_demand': return 'Arz/Talep';
                case 'manual': return 'Manuel';
                case 'inflation': return 'Enflasyon';
                case 'admin_override': return 'Admin';
                default: return reason;
            }
        }

        async function runGlobalPriceAdjustment() {
            if (!confirm('TÃ¼m pazar iÃ§in fiyat dengeleme iÅŸlemi baÅŸlatÄ±lsÄ±n mÄ±?')) return;

            try {
                showLoading();
                const response = await API.call('/admin/market/global-price-adjustment', 'POST');

                if (response.success) {
                    alert(`${response.data.totalAdjustments} fiyat ayarlama iÅŸlemi gerÃ§ekleÅŸtirildi`);
                    loadEconomicData();
                }
            } catch (error) {
                console.error('Price adjustment error:', error);
                alert('Fiyat ayarlama iÅŸlemi baÅŸarÄ±sÄ±z');
            } finally {
                hideLoading();
            }
        }

        async function viewShopDetails(shopId) {
            window.location.href = `/shops.html?shop=${shopId}&tab=economic`;
        }

        async function viewProductAnalysis(productId) {
            // Future: Open product analysis modal
            window.location.href = `/analytics.html?product=${productId}`;
        }

        async function resetShopInventory(shopId) {
            if (!confirm('Bu dÃ¼kkanÄ±n tÃ¼m envanteri sÄ±fÄ±rlansÄ±n mÄ±?')) return;

            try {
                showLoading();
                const response = await API.call(`/admin/shops/${shopId}/reset-inventory`, 'POST');

                if (response.success) {
                    alert('DÃ¼kkan envanteri sÄ±fÄ±rlandÄ±');
                    loadEconomicData();
                }
            } catch (error) {
                console.error('Reset inventory error:', error);
                alert('Envanter sÄ±fÄ±rlama baÅŸarÄ±sÄ±z');
            } finally {
                hideLoading();
            }
        }

        function showLoading() {
            document.getElementById('loading-modal').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-modal').style.display = 'none';
        }
    </script>
</body>
</html>
