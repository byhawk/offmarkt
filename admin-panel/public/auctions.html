<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Baron Admin - Ä°haleler</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <main class="main-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ðŸ”¨</div>
                    <div class="stat-content">
                        <h3 id="active-auctions">0</h3>
                        <p>Aktif Ä°haleler</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-content">
                        <h3 id="completed-auctions">0</h3>
                        <p>Tamamlanan Ä°haleler</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ’°</div>
                    <div class="stat-content">
                        <h3 id="total-revenue">â‚º0</h3>
                        <p>Toplam Gelir</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ“Š</div>
                    <div class="stat-content">
                        <h3 id="avg-bid">â‚º0</h3>
                        <p>Ort. Teklif</p>
                    </div>
                </div>
            </div>

            <header class="header">
                <h1>Ä°haleler</h1>
                <div class="header-actions">
                    <button onclick="refreshAuctions()" class="btn-refresh">ðŸ”„ Yenile</button>
                </div>
            </header>

            <div class="section">
                <h2>Aktif Ä°haleler</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÃœrÃ¼n</th>
                                <th>BaÅŸlangÄ±Ã§ FiyatÄ±</th>
                                <th>Mevcut Fiyat</th>
                                <th>Teklif SayÄ±sÄ±</th>
                                <th>Kalan SÃ¼re</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="auctionsTable">
                            <tr><td colspan="6" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Tamamlanan Ä°haleler</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÃœrÃ¼n</th>
                                <th>BaÅŸlangÄ±Ã§ FiyatÄ±</th>
                                <th>Final FiyatÄ±</th>
                                <th>Kazanan</th>
                                <th>Teklif SayÄ±sÄ±</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="completedTable">
                            <tr><td colspan="6" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadAuctions();
        });

        async function loadAuctions() {
            try {
                const activeResult = await API.call('/auction?status=active');
                const completedResult = await API.call('/auction?status=completed');

                if (activeResult && activeResult.success) {
                    updateStats(activeResult.data.auctions, completedResult?.data?.auctions || []);
                    displayActiveAuctions(activeResult.data.auctions);
                    displayCompletedAuctions(completedResult?.data?.auctions || []);
                }
            } catch (error) {
                console.error('Load auctions error:', error);
            }
        }

        function updateStats(active, completed) {
            document.getElementById('active-auctions').textContent = active?.length || 0;
            document.getElementById('completed-auctions').textContent = completed?.length || 0;

            let totalRevenue = 0;
            let totalBids = 0;
            let bidCount = 0;

            completed.forEach(a => {
                if (a.finalPrice) {
                    totalRevenue += a.finalPrice;
                    totalBids += a.finalPrice;
                    bidCount++;
                }
            });

            document.getElementById('total-revenue').textContent = 'â‚º' + formatCurrency(totalRevenue);
            document.getElementById('avg-bid').textContent = 'â‚º' + formatCurrency(bidCount > 0 ? totalBids / bidCount : 0);
        }

        function displayActiveAuctions(auctions) {
            const tbody = document.getElementById('auctionsTable');
            if (!auctions || auctions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Aktif ihale bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = auctions.map(a => `
                <tr>
                    <td>${a.itemName}</td>
                    <td>â‚º${formatCurrency(a.startPrice)}</td>
                    <td>â‚º${formatCurrency(a.currentPrice)}</td>
                    <td>${a.numberOfBids || 0}</td>
                    <td>${getTimeRemaining(a.endDate)}</td>
                    <td><span class="badge success">Aktif</span></td>
                </tr>
            `).join('');
        }

        function displayCompletedAuctions(auctions) {
            const tbody = document.getElementById('completedTable');
            if (!auctions || auctions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Tamamlanan ihale bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = auctions.map(a => `
                <tr>
                    <td>${a.itemName}</td>
                    <td>â‚º${formatCurrency(a.startPrice)}</td>
                    <td>â‚º${formatCurrency(a.finalPrice || 0)}</td>
                    <td>${a.winnerName || '-'}</td>
                    <td>${a.numberOfBids || 0}</td>
                    <td><span class="badge ${a.status === 'completed' ? 'success' : 'secondary'}">${a.status === 'completed' ? 'TamamlandÄ±' : 'BaÅŸarÄ±sÄ±z'}</span></td>
                </tr>
            `).join('');
        }

        function getTimeRemaining(endDate) {
            const now = new Date();
            const end = new Date(endDate);
            const diff = end - now;

            if (diff <= 0) return 'Bitti';

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            return `${hours}h ${minutes}m`;
        }

        function refreshAuctions() {
            loadAuctions();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR').format(amount);
        }
    </script>
</body>
</html>
