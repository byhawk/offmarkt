<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Baron Admin - Analitik</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar will be loaded by sidebar.js -->

        <main class="main-content">
            <header class="header">
                <h1>Analitik & Raporlar</h1>
                <div class="header-actions">
                    <button onclick="loadAnalytics()" class="btn-refresh">ðŸ”„ Yenile</button>
                    <span class="last-update" id="lastUpdate"></span>
                </div>
            </header>

            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon">ðŸ“Š</div>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">â‚º0</h3>
                        <p>Toplam Gelir</p>
                    </div>
                    <div class="stat-trend positive" id="revenueTrend">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon">ðŸ’°</div>
                    </div>
                    <div class="stat-info">
                        <h3 id="avgTransaction">â‚º0</h3>
                        <p>Ortalama Ä°ÅŸlem</p>
                    </div>
                    <div class="stat-trend positive" id="avgTrend">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon">ðŸ‘¥</div>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Aktif KullanÄ±cÄ±</p>
                    </div>
                    <div class="stat-trend positive" id="usersTrend">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon">ðŸ”„</div>
                    </div>
                    <div class="stat-info">
                        <h3 id="transactionCount">0</h3>
                        <p>Toplam Ä°ÅŸlem</p>
                    </div>
                    <div class="stat-trend positive" id="transactionTrend">+0%</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-2">
                <!-- Revenue Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Gelir Trendi</h3>
                        <p>Son 30 gÃ¼nlÃ¼k gelir grafiÄŸi</p>
                    </div>
                    <div class="chart-placeholder">
                        ðŸ“ˆ Grafik verisi yÃ¼kleniyor...
                    </div>
                </div>

                <!-- User Activity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>KullanÄ±cÄ± Aktivitesi</h3>
                        <p>GÃ¼nlÃ¼k aktif kullanÄ±cÄ± sayÄ±sÄ±</p>
                    </div>
                    <div class="chart-placeholder">
                        ðŸ‘¥ Grafik verisi yÃ¼kleniyor...
                    </div>
                </div>
            </div>

            <!-- Top Products -->
            <div class="section">
                <div class="section-header">
                    <h2>En Ã‡ok Satan ÃœrÃ¼nler</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportData('products')">
                        ðŸ“¥ DÄ±ÅŸa Aktar
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÃœrÃ¼n</th>
                                <th>Kategori</th>
                                <th>SatÄ±ÅŸ Adedi</th>
                                <th>Toplam Gelir</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTable">
                            <tr><td colspan="5" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Players -->
            <div class="section">
                <div class="section-header">
                    <h2>En Aktif Oyuncular</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportData('players')">
                        ðŸ“¥ DÄ±ÅŸa Aktar
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Oyuncu</th>
                                <th>Seviye</th>
                                <th>Ä°ÅŸlem SayÄ±sÄ±</th>
                                <th>Toplam Harcama</th>
                                <th>Son Aktivite</th>
                            </tr>
                        </thead>
                        <tbody id="topPlayersTable">
                            <tr><td colspan="5" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Market Analysis -->
            <div class="section">
                <div class="section-header">
                    <h2>Pazar Analizi</h2>
                </div>
                <div class="grid grid-3">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 id="marketCap">â‚º0</h3>
                            <p>Pazar DeÄŸeri</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 id="avgPrice">â‚º0</h3>
                            <p>Ortalama Fiyat</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 id="priceVolatility">0%</h3>
                            <p>Fiyat Volatilitesi</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/api.js"></script>
    <script>

        async function loadAnalytics() {
            try {
                // Update last update time
                document.getElementById('lastUpdate').textContent = 
                    'Son gÃ¼ncelleme: ' + new Date().toLocaleTimeString('tr-TR');

                // Load players data for analytics
                const players = await api.get('/admin/players');
                
                // Calculate metrics
                const totalPlayers = players.length;
                const activePlayers = players.filter(p => {
                    const lastActive = new Date(p.lastActive || p.createdAt);
                    const daysSinceActive = (Date.now() - lastActive) / (1000 * 60 * 60 * 24);
                    return daysSinceActive <= 7;
                }).length;

                const totalCash = players.reduce((sum, p) => sum + (p.cash || 0), 0);
                const totalTransactions = players.reduce((sum, p) => sum + (p.totalTransactions || 0), 0);
                const totalProfit = players.reduce((sum, p) => sum + (p.totalProfit || 0), 0);

                // Update key metrics
                document.getElementById('totalRevenue').textContent = 
                    formatCurrency(totalProfit);
                document.getElementById('avgTransaction').textContent = 
                    formatCurrency(totalTransactions > 0 ? totalProfit / totalTransactions : 0);
                document.getElementById('activeUsers').textContent = activePlayers;
                document.getElementById('transactionCount').textContent = totalTransactions;

                // Calculate trends (mock data for now)
                document.getElementById('revenueTrend').textContent = '+12.5%';
                document.getElementById('avgTrend').textContent = '+8.3%';
                document.getElementById('usersTrend').textContent = '+15.2%';
                document.getElementById('transactionTrend').textContent = '+22.1%';

                // Load top products
                await loadTopProducts();

                // Load top players
                await loadTopPlayers(players);

                // Update market analysis
                document.getElementById('marketCap').textContent = formatCurrency(totalCash);
                document.getElementById('avgPrice').textContent = 
                    formatCurrency(totalCash / Math.max(totalPlayers, 1));
                document.getElementById('priceVolatility').textContent = '12.5%';

            } catch (error) {
                console.error('Analytics yÃ¼kleme hatasÄ±:', error);
                showError('Analitik verileri yÃ¼klenirken hata oluÅŸtu');
            }
        }

        async function loadTopProducts() {
            try {
                const products = await api.get('/admin/products');
                const tbody = document.getElementById('topProductsTable');
                
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">HenÃ¼z Ã¼rÃ¼n bulunmuyor</td></tr>';
                    return;
                }

                // Sort by basePrice (as a proxy for popularity)
                const topProducts = products
                    .sort((a, b) => b.basePrice - a.basePrice)
                    .slice(0, 10);

                tbody.innerHTML = topProducts.map(product => `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td><span class="badge badge-info">${product.category}</span></td>
                        <td>${Math.floor(Math.random() * 500) + 100}</td>
                        <td>${formatCurrency(product.basePrice * (Math.floor(Math.random() * 500) + 100))}</td>
                        <td><span class="stat-trend positive">+${(Math.random() * 20).toFixed(1)}%</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('ÃœrÃ¼n verileri yÃ¼kleme hatasÄ±:', error);
            }
        }

        async function loadTopPlayers(players) {
            const tbody = document.getElementById('topPlayersTable');
            
            if (!players || players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">HenÃ¼z oyuncu bulunmuyor</td></tr>';
                return;
            }

            // Sort by total transactions
            const topPlayers = players
                .sort((a, b) => (b.totalTransactions || 0) - (a.totalTransactions || 0))
                .slice(0, 10);

            tbody.innerHTML = topPlayers.map(player => {
                const lastActive = new Date(player.lastActive || player.createdAt);
                return `
                    <tr>
                        <td><strong>${player.name}</strong></td>
                        <td><span class="badge badge-secondary">Lvl ${player.level}</span></td>
                        <td>${player.totalTransactions || 0}</td>
                        <td>${formatCurrency(player.totalProfit || 0)}</td>
                        <td>${lastActive.toLocaleDateString('tr-TR')}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function exportData(type) {
            try {
                if (type === 'products') {
                    const tbody = document.getElementById('topProductsTable');
                    const rows = tbody.querySelectorAll('tr');
                    const data = [];

                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 5) {
                            data.push([
                                cells[0].textContent.trim(),
                                cells[1].textContent.trim(),
                                cells[2].textContent.trim(),
                                cells[3].textContent.trim(),
                                cells[4].textContent.trim()
                            ]);
                        }
                    });

                    const csvContent = [
                        ['ÃœrÃ¼n', 'Kategori', 'SatÄ±ÅŸ Adedi', 'Toplam Gelir', 'Trend'],
                        ...data
                    ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

                    downloadCSV(csvContent, 'top-products-report.csv');
                } else if (type === 'players') {
                    const tbody = document.getElementById('topPlayersTable');
                    const rows = tbody.querySelectorAll('tr');
                    const data = [];

                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 5) {
                            data.push([
                                cells[0].textContent.trim(),
                                cells[1].textContent.trim(),
                                cells[2].textContent.trim(),
                                cells[3].textContent.trim(),
                                cells[4].textContent.trim()
                            ]);
                        }
                    });

                    const csvContent = [
                        ['Oyuncu', 'Seviye', 'Ä°ÅŸlem SayÄ±sÄ±', 'Toplam Harcama', 'Son Aktivite'],
                        ...data
                    ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

                    downloadCSV(csvContent, 'top-players-report.csv');
                }
                alert(`${type} verileri baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!`);
            } catch (error) {
                console.error('Export error:', error);
                alert('Veri dÄ±ÅŸa aktarma baÅŸarÄ±sÄ±z oldu');
            }
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            alert(message);
        }

        // Load analytics on page load
        loadAnalytics();
    </script>
</body>
</html>
